@page "/Ambiente"
@rendermode InteractiveServer
@using TASKWAVE.WEB.Components.Layout
@layout NavMenu
@inject HttpClient Http

<div class="sidebar">
	<NavMenuOptions Options="@Options" />
</div>

<div class="m-md-5">
	<h2>Meus Ambientees</h2>
	<h4 class="mt-3">Gerenciar Ambientees</h4>		

	@foreach (var environment in environmentList)
	{

		<div class="mb-3">
			<label>@environment.environmentName</label>
			<label>@environment.environmentDescription</label>
			<button class="btn btn-sm btn-primary" @onclick="() => OpenEditModal(environment)">Editar</button>
		</div>

	}
</div>

@if (selectedEnvironment != null)
{
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
		<div class="modal-dialog">
			<div class="modal-content text-black">
				<div class="modal-header">
					<h5 class="modal-title">Editar Ambiente</h5>
					<button type="button" class="btn-close" @onclick="CloseModal"></button>
				</div>
				<div class="modal-body">
					<EditForm Model="@selectedEnvironment" OnValidSubmit="UpdateEnvironment">
						<DataAnnotationsValidator />
						<ValidationSummary />

						<div class="mb-3">
							<label>Nome</label>
							<InputText class="form-control" @bind-Value="selectedEnvironment.environmentName" />
						</div>

						<div class="mb-3">
							<label>Descrição</label>
							<InputText class="form-control" @bind-Value="selectedEnvironment.environmentDescription" />
						</div>

						<button type="button" class="btn btn-success" @onclick="() => DeleteEnvironment(selectedEnvironment.environmentId)">Excluir Ambiente</button>
						<button type="submit" class="btn btn-success">Salvar</button>
						<button type="button" class="btn btn-secondary ms-2" @onclick="CloseModal">Cancelar</button>
					</EditForm>
				</div>
			</div>
		</div>
	</div>
}

@code {

	List<HyperLink> Options = new List<HyperLink>
	{
		new HyperLink("/AmbienteCreate", "Criar Ambiente", "Criar Ambiente", HyperLink.TypeOfIcon.Add),
		new HyperLink("/Ambiente", "Gerenciar Ambientes", "Gerenciar Ambientes", HyperLink.TypeOfIcon.List)
	};

	private List<AmbienteResponse> environmentList = new();
	private string mensageResponse;
	private AmbienteRequest selectedEnvironment;

	protected override async Task OnInitializedAsync()
	{
		await GetAllEnvironments();
	}

	#region CRUD
	private async Task GetAllEnvironments()
	{
		try
		{
			environmentList = await Http.GetFromJsonAsync<List<AmbienteResponse>>("api/Ambiente");
		}
		catch (Exception ex)
		{
			mensageResponse = $"Erro ao carregar ambientes: {ex.Message}";
		}
	}

	
	private async Task DeleteEnvironment(int environmentId)
	{
		try
		{
			var response = await Http.DeleteAsync($"api/Ambiente/{environmentId}");

			if (response.IsSuccessStatusCode)
			{
				await GetAllEnvironments();
				CloseModal();
			}
			else
			{
				mensageResponse = "Erro ao excluir Ambiente.";
			}
		}
		catch (Exception ex)
		{
			mensageResponse = $"Erro: {ex.Message}";
		}
	}
	
	private async Task UpdateEnvironment()
	{
		try
		{
			var response = await Http.PutAsJsonAsync($"api/Ambiente/{selectedEnvironment.environmentId}", selectedEnvironment);
			if (response.IsSuccessStatusCode)
			{
				await GetAllEnvironments();
				CloseModal();
			}
			else
			{
				mensageResponse = "Erro ao atualizar Ambiente.";
			}
		}
		catch (Exception ex)
		{
			mensageResponse = $"Erro: {ex.Message}";
		}
	}
	#endregion


	#region Modal
	private void OpenEditModal(AmbienteResponse environment)
	{
		selectedEnvironment = new AmbienteRequest
		{
			environmentId = environment.environmentID,
			environmentName = environment.environmentName,
			environmentDescription = environment.environmentDescription
		};
	}

	private void CloseModal()
	{
		selectedEnvironment = null;
	}
	#endregion
}
